<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:p="http://primefaces.org/ui" xmlns:o="http://omnifaces.org/ui"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:pe="http://primefaces.org/ui/extensions">
	
<h:head>
	<title>Facelet Title</title>
</h:head>
<h:body>
	<ui:composition template="/WEB-INF/template/template.xhtml">
		<ui:define name="title">
			<c:set var="title" value="#{authBean.agencyGroup.agencyGroupShortname} Files #{authBean.testMode ? '[TEST MODE]':''}" scope="request" />
		</ui:define>
		<ui:define name="rightpane">
			<div class="grid-container1">
				<div id="aa" class="grid-item">
					<pe:layout position="west" resizable="true" minSize="250" maxSize="400" styleClass="layoutheight"
			    	rendered="#{p:ifGranted('Uploader') or p:ifGranted('System Admin')}">
					<h:form id="form1">	
						<p:growl id="growl" showDetail="true"/>
						<p:panelGrid styleClass="agencyGroupListPanel" columns="2" rendered="#{p:ifGranted('System Admin') and authBean.agencyGroup.accessLevel eq 1}">
							<h:outputLabel id="agencyGroupListLabel" for="agencyGroupList" value="Showing Files For: "/>
							<p:outputPanel styleClass="noborder transparent">
								<p:selectOneMenu id="agencyGroupList" value="#{agencyFilesBean.focusAgencyGroup}">
									<p:ajax event="change" listener="#{agencyFilesBean.configAgencyFiles}" update=":form1 :form2"/>
									<f:converter converterId="RefAgencyGroupConverter"/>
									<f:selectItem noSelectionOption="true" itemLabel="--Select One--" itemValue="#{null}"/>
									<f:selectItems value="#{agencyFilesBean.agencyGroupList}" var="dt" 
										itemLabel="#{dt.agencyId.agencyShortname} - #{dt.agencyGroupShortname} #{dt.accessLevel eq 1 ? '- (System Owner)': dt.accessLevel eq -1 ? '- (Disabled)':''}"
										itemValue="#{dt}"/>
								</p:selectOneMenu><br/>
								<p:selectBooleanCheckbox id="disabledCb" styleClass="tinychkbox" value="#{agencyFilesBean.includeDisabled}">
					            	<p:ajax update="agencyGroupList" process="@this" partialSubmit="true" listener="#{agencyFilesBean.updateAgencyGrouplist}"/>
				            	</p:selectBooleanCheckbox>
								<h:outputText for="disabledCb" value="Include Disabled?" style="padding-left:5px" styleClass="tinytext"/>
							</p:outputPanel>
						</p:panelGrid>
						<p:separator rendered="#{p:ifGranted('System Admin') and authBean.agencyGroup.accessLevel eq 1}"/>
						<p:tree id="foldertree" value="#{agencyFilesBean.root}" var="node"
							selection="#{agencyFilesBean.selectedNode}" selectionMode="single"
							styleClass="foldertree noborder">
							<p:ajax event="expand" listener="#{agencyFilesBean.nodeExpand}" global="false" partialSubmit="true"/>
    						<p:ajax event="collapse" listener="#{agencyFilesBean.nodeCollapse}" global="false" partialSubmit="true"/>
					        <p:treeNode type="report">
					            <h:outputText value="#{node}" />
					        </p:treeNode>
					        <p:treeNode type="folder" collapsedIcon="ui-close-folder" expandedIcon="ui-open-folder">
					        	<p:inplace editor="true" event="dblclick">
					        		<p:ajax event="save" listener="#{agencyFilesBean.editFolder(node)}" update=":form1:growl foldertree"/>
				        			<h:inputText value="#{node.displayName}" maxlength="50"/>
					        	</p:inplace>
					        </p:treeNode>
					    </p:tree>
					    <p:contextMenu event="click" targetFilter=".ui-treenode-label" nodeType="report" for="foldertree" 
					    	widgetVar="reportCMenu">
					        <p:menuitem value="New Folder" action="#{agencyFilesBean.addFolder}" icon="fa fa-plus" update=":form1:growl foldertree"
					        	rendered="#{p:ifGranted('Uploader') and (authBean.agencyGroup.agencyGroupId eq agencyFilesBean.focusAgencyGroup.agencyGroupId)}"/>
					        <p:menuitem value="No Action Available" icon="fa fa-close" rendered="#{not p:ifGranted('Uploader')}"/>
					    </p:contextMenu>
					    <p:contextMenu event="click" targetFilter=".ui-treenode-icon, .ui-inplace-display" nodeType="folder" for="foldertree"
					    	widgetVar="folderCMenu" style="padding: 6px !important;">
					    	<p:menuitem value="View" action="#{agencyFilesBean.viewFolderContent}" icon="fa fa-search" update=":form1:growl :form2"/>
					        <p:menuitem value="New Folder" action="#{agencyFilesBean.addFolder}" icon="fa fa-plus" update=":form1:growl foldertree"
					        	rendered="#{p:ifGranted('Uploader') and (authBean.agencyGroup.agencyGroupId eq agencyFilesBean.focusAgencyGroup.agencyGroupId)}"/>
					        <p:menuitem value="Delete" onclick="PF('cd').show()" icon="fa fa-remove"
					        	rendered="#{p:ifGranted('System Admin')}"/>
					    </p:contextMenu>
					    
					    <p:confirmDialog message="Are you sure you want to delete this folder?" appendTo="@(body)"
							header="Confirm Delete" severity="alert"
							widgetVar="cd">
							<p:commandButton value="Yes" actionListener="#{agencyFilesBean.deleteFolder}"
							update=":form1:growl foldertree" oncomplete="PF('cd').hide()"/>
							<p:commandButton value="No" onclick="PF('cd').hide();" type="button" />
						</p:confirmDialog>
				    </h:form>
			    	</pe:layout>
				</div>
				
				<div class="grid-container2">
					<div id="bb" class="grid-item">
					<pe:layout position="center" styleClass="layoutheight">
			    
			    	<div class="grid-container2">
			    		<div id="cc" class="grid-item">
			    			<pe:layout id="inner_center" position="center" styleClass="noborder">
					    	<h:form id="form2">
								<p:growl showDetail="true"/>
								<p:fileUpload label="Add to #{agencyFilesBean.selectedNode.data.displayName}" auto="true" update="@form :form4"
									multiple="true" sequential="true"
									onstart="PF('statusDialog').show();"
									onerror="PF('statusDialog').hide()"
									rendered="#{p:ifGranted('Uploader') and (authBean.agencyGroup.agencyGroupId eq agencyFilesBean.focusAgencyGroup.agencyGroupId) and agencyFilesBean.selectedNode ne null}" 
									listener="#{agencyFilesBean.handleFileUpload}" allowTypes="/(\.|\/)(pdf|xls|xls?x|ppt|ppt?x|doc|doc?x)$/"/>
					    		<p:dataTable id="reporttable" value="#{agencyFilesBean.entityList}" var="report"
					    			selection="#{agencyFilesBean.selectedFiles}" rowKey="#{report.filePropertyId}">
					    			
					    			<p:ajax disabled="#{p:ifGranted('Uploader')}" event="toggleSelect" global="false" process="@this" update=":form2:deleteSelected"/>
					    			<p:ajax disabled="#{p:ifGranted('Uploader')}" event="rowSelect" global="false" process="@this" update=":form2:deleteSelected"/>
					    			<p:ajax disabled="#{p:ifGranted('Uploader')}" event="rowUnselect" global="false" process="@this" update=":form2:deleteSelected"/>
					    			<p:ajax disabled="#{p:ifGranted('Uploader')}" event="rowSelectCheckbox" global="false" process="@this" update=":form2:deleteSelected"/>
					    			<p:ajax disabled="#{p:ifGranted('Uploader')}" event="rowUnselectCheckbox" global="false" process="@this" update=":form2:deleteSelected"/>
					    			
					    			<p:column selectionMode="multiple" style="width:16px;text-align:center"
					    				rendered="#{p:ifGranted('System Admin')}"/>
						    		<p:column headerText="Name">
						    			<p:panelGrid styleClass="noborder_table transparent_table">
						    				<p:row>
							    				<p:column style="width: 15px;">
							    					<span class="ui-icon #{report.fileType eq 2 ? 'ui-pdf':
							    									report.fileType eq 3 ? 'ui-xls':
							    									report.fileType eq 4 ? 'ui-ppt':
							    									report.fileType eq 5 ? 'ui-doc':''}"></span>
							    				</p:column>
							    				<p:column>
							    					<h:outputText style="" value="#{report.fileName}"/>
							    				</p:column>
						    				</p:row>
						    			</p:panelGrid>
						    		</p:column>
						    		<p:column headerText="Size" width="60" style="text-align:center">
						    			#{report.size}
						    		</p:column>
						    		<p:column headerText="Date Updated" style="text-align:center">
							    		<h:outputText value="#{report.cdate}" >
										    <f:convertDateTime pattern="MMM dd yyyy" />
										</h:outputText>
						    			
						    		</p:column>
						    		<p:column headerText="Actions" width="70"  style="text-align:center">
						    			<p:commandButton icon="fa fa-download" label="download" 
						    				ajax="false" action="#{agencyFilesBean.download(report)}"/>
						    			<p:commandButton process="@this" onclick="PF('cd2').show()"
						    				rendered="#{p:ifGranted('System Admin')}"
						    				icon="fa fa-remove" title="delete">
						    				<f:setPropertyActionListener target="#{agencyFilesBean.forDelete}" value="#{report}"/>
					    				</p:commandButton>
						    		</p:column>
						    	</p:dataTable>
					    		<p:commandButton id="deleteSelected" value="Delete Selected Files" 
					    			onclick="PF('cd3').show()"
					    			disabled="#{!(agencyFilesBean.selectedFiles.size() lt 1 or empty agencyFilesBean.selectedFiles)}" style="float:right;"
					    			rendered="#{p:ifGranted('System Admin')}" />
					    	</h:form>
				    		</pe:layout>
			    		</div>
			    	</div>
			    	</pe:layout>
				</div>
				</div>  
			</div>
			
			<div class="grid-container3">
				<div id="bb" class="grid-item">
					<pe:layout id="inner_south" position="south" size="25" styleClass="noborder">
			    		<h:form id="form4">
			    			<h:outputText value="#{agencyFilesBean.agencyStorageUtilization}" style="font-weight:bold;float:right"/>
			    		</h:form>
					</pe:layout>
				</div>
			</div>

				<p:confirmDialog message="Are you sure you want to delete this file?" appendTo="@(body)"
								header="Confirm Delete" severity="alert"
								widgetVar="cd2">
						
					<h:form id="form3">
						<p:commandButton value="Yes" actionListener="#{agencyFilesBean.delete}"
						update=":form2" oncomplete="PF('cd2').hide()"/>
						<p:commandButton value="No" onclick="PF('cd2').hide();" type="button" />
					</h:form>
				</p:confirmDialog>
				
				<p:confirmDialog message="Are you sure you want to delete the selected file/s?" appendTo="@(body)"
								header="Confirm Delete" severity="alert"
								widgetVar="cd3">
					
					<h:form id="form5">
						<p:commandButton value="Yes" actionListener="#{agencyFilesBean.removeSelectedFiles()}"
						update=":form2 :form4" oncomplete="PF('cd3').hide()"/>
						<p:commandButton value="No" onclick="PF('cd3').hide();" type="button" />
					</h:form>
				</p:confirmDialog>
		</ui:define>
	</ui:composition>
</h:body>
</html>
